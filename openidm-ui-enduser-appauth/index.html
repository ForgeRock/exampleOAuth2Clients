<!--
  Copyright 2015-2017 ForgeRock AS. All Rights Reserved

  Use of this code requires a commercial software license with ForgeRock AS.
  or with one of its affiliates. All use shall be exclusively subject
  to such license between the licensee and ForgeRock AS.
-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>OpenIDM</title>

</head>

<body style="display:none">

<div id="messages"></div>
<div id="wrapper"></div>
<div id="popup">
    <div id="popup-content" class="radious"></div>
</div>

<div id="dialog-background"></div>
<div id="dialogs"></div>

<footer id="footer" class="footer"></footer>

<script type="text/javascript">
    var require = {
        urlArgs : "v=6.0.0",
        deps : ['main']
    };
</script>

<script src="appAuthFrame.js"></script>
<script>
(function () {
    // handle various token-related events issued from the appAuthFrame as appropriate in the SPA context
    // "appAuthLoaded" - the iframe is ready to start working. Send it a "login" message whenever you're ready to get tokens.
    // "tokensAvailable" - the access token and id token are now saved in sessionStorage
    // "tokensRenewed" - the access token and id token that were in sessionStorage have been replaced with updated tokens
    // "tokensRemoved" - there are no longer tokens available (probably due to a logout event)
    window.addEventListener("message", function (e) {
        if (e.origin !== document.location.origin) {
            return;
        }
        switch (e.data) {
            case "tokensRenewed":
            case "tokensAvailable":
                // load the main SPA app once the tokens are available / fresh
                if (!document.getElementById("mainScript")) {
                    var mainScript = document.createElement("script");
                    mainScript.setAttribute("src", "libs/requirejs-2.1.14-min.js");
                    mainScript.setAttribute("data-main", "main");
                    mainScript.setAttribute("id", "mainScript");
                    document.getElementsByTagName("body")[0].appendChild(mainScript);
                }
                break;
            case "tokensRemoved":
                // reset the SPA if the tokens are gone, triggering a new login flow
                window.location.href = "";
                break;
            case "appAuthLoaded":
                // In this application, we want tokens immediately, before any user interaction is attempted
                document.getElementById("appAuthFrame").contentWindow.postMessage("getTokens", document.location.origin);
                break;
        }
    }, false);

    // trigger logout from anywhere in the SPA by calling this global function
    window.logout = function () {
        document.getElementById("appAuthFrame").contentWindow.postMessage("removeTokens", document.location.origin);
    };
}());
</script>

</body>
</html>
